#!/usr/bin/env sh

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 错误计数
ERRORS=0

echo "${BLUE}🚀 Running pre-commit checks...${NC}"

# 1. 检查前端代码 (ESLint + Prettier)
echo "${BLUE}🔍 Checking frontend code quality and format...${NC}"
yarn review:frontend
if [ $? -ne 0 ]; then
  echo "${RED}❌ Frontend code check failed!${NC}"
  echo "${YELLOW}💡 Fix with: yarn fix:frontend${NC}"
  ERRORS=$((ERRORS + 1))
fi

# 2. 检查Rust代码 (编译 + Clippy)
echo "${BLUE}🔍 Checking Rust code compilation and quality...${NC}"
yarn review:rust
if [ $? -ne 0 ]; then
  echo "${RED}❌ Rust code check failed!${NC}"
  echo "${YELLOW}💡 Fix with: yarn fix:rust${NC}"
  ERRORS=$((ERRORS + 1))
fi

# 总结
if [ $ERRORS -eq 0 ]; then
  echo "${GREEN}✅ All pre-commit checks passed!${NC}"
  exit 0
else
  echo "${RED}❌ Pre-commit checks failed with $ERRORS error(s)!${NC}"
  echo ""
  echo "${YELLOW}📋 修复步骤:${NC}"
  echo "   1. 修复前端代码: ${BLUE}yarn fix:frontend${NC}"
  echo "   2. 修复Rust代码: ${BLUE}yarn fix:rust${NC}"
  echo ""
  echo "${YELLOW}💡 一键修复所有问题:${NC}"
  echo "   ${BLUE}yarn fix${NC}"
  echo ""
  echo "${YELLOW}💡 一键检查所有问题:${NC}"
  echo "   ${BLUE}yarn review${NC}"
  echo ""
  echo "${RED}请修复上述问题后重新提交！${NC}"
  exit 1
fi